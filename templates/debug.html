{% extends "base.html" %}

{% block title %}Debug & Test - ExpiredDomain.dev{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-6 py-12">
    <!-- Header -->
    <div class="mb-10">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-4xl font-bold text-frost mb-2 flex items-center gap-3">
                    <span class="text-3xl">üîç</span> Debug & Test Page
                </h1>
                <p class="text-mist">Check download, parse, and database status</p>
            </div>
            <!-- Auto Refresh Controls -->
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="auto-refresh-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-steel rounded-full peer peer-checked:after:translate-x-full peer-checked:bg-neon-green after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-frost after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                    </label>
                    <span class="text-mist text-sm">Auto Refresh</span>
                </div>
                <select id="refresh-interval" class="px-3 py-2 bg-void border border-steel rounded-xl text-frost text-sm focus:ring-2 focus:ring-neon-cyan">
                    <option value="5000">5s</option>
                    <option value="10000" selected>10s</option>
                    <option value="30000">30s</option>
                    <option value="60000">60s</option>
                </select>
                <button id="manual-refresh" class="px-4 py-2 bg-neon-cyan/10 hover:bg-neon-cyan/20 text-neon-cyan rounded-xl text-sm font-medium transition-colors">
                    üîÑ Refresh Now
                </button>
                <div id="refresh-indicator" class="hidden">
                    <div class="animate-spin w-5 h-5 border-2 border-neon-cyan border-t-transparent rounded-full"></div>
                </div>
            </div>
        </div>
        <!-- Last Update Info -->
        <div class="mt-4 flex items-center gap-4">
            <span class="text-sm text-mist">Last updated: <span id="last-update" class="text-frost font-mono">-</span></span>
            <span id="auto-refresh-status" class="hidden px-2 py-1 rounded-lg bg-neon-green/10 text-neon-green text-xs font-medium">
                <span class="inline-block w-2 h-2 rounded-full bg-neon-green animate-pulse mr-1"></span>
                Auto-refreshing
            </span>
        </div>
    </div>
    
    <!-- Parse Status -->
    <div id="parseStatus" class="hidden mb-6"></div>

    {% if status.errors %}
    <div class="bg-red-500/10 border border-red-500/30 rounded-2xl p-6 mb-6">
        <h3 class="font-bold text-red-400 mb-3 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            Errors Detected
        </h3>
        <ul class="list-disc list-inside text-red-300 space-y-1">
            {% for error in status.errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Data Directory Status -->
    <div class="relative rounded-2xl bg-gradient-to-br from-night to-carbon border border-steel/50 p-8 mb-6 overflow-hidden">
        <div class="absolute top-0 right-0 w-40 h-40 bg-neon-cyan/5 rounded-full blur-3xl"></div>
        <div class="relative">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-xl bg-neon-cyan/10 flex items-center justify-center">
                    <span class="text-2xl">üìÅ</span>
                </div>
                <h2 class="text-2xl font-bold text-frost">Data Directory Status</h2>
            </div>
            <div class="space-y-3">
                <div class="flex items-center p-4 rounded-xl bg-void/50">
                    <span class="w-32 text-mist text-sm">Data Dir:</span>
                    <span class="font-mono text-sm flex-1 {% if status.data_dir_exists %}text-neon-green{% else %}text-red-400{% endif %}">
                        {{ status.data_dir_path }}
                    </span>
                    {% if status.data_dir_exists %}
                        <span class="w-8 h-8 rounded-lg bg-neon-green/20 flex items-center justify-center text-neon-green">‚úì</span>
                    {% else %}
                        <span class="w-8 h-8 rounded-lg bg-red-500/20 flex items-center justify-center text-red-400">‚úó</span>
                    {% endif %}
                </div>
                <div class="flex items-center p-4 rounded-xl bg-void/50">
                    <span class="w-32 text-mist text-sm">Zones Dir:</span>
                    <span class="font-mono text-sm flex-1 {% if status.zones_dir_exists %}text-neon-green{% else %}text-red-400{% endif %}">
                        {{ status.zones_dir_path }}
                    </span>
                    {% if status.zones_dir_exists %}
                        <span class="w-8 h-8 rounded-lg bg-neon-green/20 flex items-center justify-center text-neon-green">‚úì</span>
                    {% else %}
                        <span class="w-8 h-8 rounded-lg bg-red-500/20 flex items-center justify-center text-red-400">‚úó</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Database Statistics -->
    <div class="relative rounded-2xl bg-gradient-to-br from-night to-carbon border border-steel/50 p-8 mb-6 overflow-hidden">
        <div class="absolute top-0 right-0 w-40 h-40 bg-neon-purple/5 rounded-full blur-3xl"></div>
        <div class="relative">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-xl bg-neon-purple/10 flex items-center justify-center">
                    <span class="text-2xl">üìä</span>
                </div>
                <h2 class="text-2xl font-bold text-frost">Database Statistics</h2>
            </div>
            
            {% if not status.db_available %}
            <div class="bg-amber-500/10 border border-amber-500/30 rounded-xl p-4 mb-6">
                <p class="text-amber-400 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    Database connection unavailable. Showing filesystem data only.
                </p>
            </div>
            {% endif %}
            
            {% if status.db_stats_error %}
            <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
                <p class="text-red-400">Error: {{ status.db_stats_error }}</p>
            </div>
            {% else %}
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="p-4 rounded-xl bg-void/50 border border-steel/30">
                    <div class="text-sm text-mist mb-1">Total Drops</div>
                    <div class="text-3xl font-bold text-frost font-mono">{{ status.db_stats.total_drops | default(0) }}</div>
                </div>
                <div class="p-4 rounded-xl bg-void/50 border border-steel/30">
                    <div class="text-sm text-mist mb-1">Latest Drop Date</div>
                    <div class="text-lg font-semibold text-neon-cyan font-mono">{{ status.db_stats.latest_drop_date | default('N/A') }}</div>
                </div>
                <div class="p-4 rounded-xl bg-void/50 border border-steel/30">
                    <div class="text-sm text-mist mb-1">Earliest Drop Date</div>
                    <div class="text-lg font-semibold text-neon-purple font-mono">{{ status.db_stats.earliest_drop_date | default('N/A') }}</div>
                </div>
            </div>
            
            {% if status.db_stats.drops_by_date %}
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-frost mb-4">Drops by Date (Last 7 Days)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-steel/30">
                                <th class="text-left py-3 px-4 text-mist font-medium text-sm uppercase tracking-wider">Date</th>
                                <th class="text-left py-3 px-4 text-mist font-medium text-sm uppercase tracking-wider">Count</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-steel/20">
                            {% for item in status.db_stats.drops_by_date %}
                            <tr class="hover:bg-steel/20 transition-colors">
                                <td class="py-3 px-4 font-mono text-mist">{{ item.date }}</td>
                                <td class="py-3 px-4 font-mono font-semibold text-neon-cyan">{{ item.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- TLDs and Zone Files -->
    <div class="relative rounded-2xl bg-gradient-to-br from-night to-carbon border border-steel/50 p-8 mb-6 overflow-hidden">
        <div class="absolute top-0 right-0 w-40 h-40 bg-neon-pink/5 rounded-full blur-3xl"></div>
        <div class="relative">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-xl bg-neon-pink/10 flex items-center justify-center">
                    <span class="text-2xl">üåê</span>
                </div>
                <h2 class="text-2xl font-bold text-frost">TLDs & Zone Files</h2>
            </div>
            
            {% if status.db_error and not status.tlds %}
            <div class="bg-amber-500/10 border border-amber-500/30 rounded-xl p-4 mb-6">
                <p class="text-amber-400">
                    ‚ö†Ô∏è Database Error: {{ status.db_error }}<br>
                    <span class="text-sm">Showing zone files from filesystem instead.</span>
                </p>
            </div>
            {% endif %}
            
            {% if status.tlds %}
            {% for tld in status.tlds %}
            <div class="mb-6 border-b border-steel/30 pb-6 {% if loop.last %}border-b-0 pb-0 mb-0{% endif %}">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-frost flex items-center gap-3">
                        <span class="inline-flex items-center px-3 py-1 rounded-lg bg-neon-cyan/10 text-neon-cyan">.{{ tld.name }}</span>
                    </h3>
                    <div class="text-sm text-mist">
                        {% if not tld.from_filesystem %}
                            <span class="font-semibold text-frost">{{ tld.drop_count }}</span> domains in DB
                            {% if tld.last_import_date %}
                                <span class="text-mist/60">| Last import:</span> <span class="text-neon-purple">{{ tld.last_import_date }}</span>
                            {% endif %}
                        {% else %}
                            <span class="text-amber-400">‚ö†Ô∏è From filesystem (DB unavailable)</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if tld.zone_files %}
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-steel/20">
                                <th class="text-left py-3 px-3 text-mist font-medium text-xs uppercase tracking-wider">Zone File</th>
                                <th class="text-left py-3 px-3 text-mist font-medium text-xs uppercase tracking-wider">Date</th>
                                <th class="text-left py-3 px-3 text-mist font-medium text-xs uppercase tracking-wider">Size</th>
                                <th class="text-left py-3 px-3 text-mist font-medium text-xs uppercase tracking-wider">SLDs Found</th>
                                <th class="text-left py-3 px-3 text-mist font-medium text-xs uppercase tracking-wider">Status</th>
                                <th class="text-left py-3 px-3 text-mist font-medium text-xs uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-steel/10">
                            {% for zone in tld.zone_files %}
                            <tr class="hover:bg-steel/10 transition-colors">
                                <td class="py-3 px-3 font-mono text-xs text-mist">{{ zone.name }}</td>
                                <td class="py-3 px-3 text-mist">{{ zone.date | default('N/A') }}</td>
                                <td class="py-3 px-3 text-mist">{{ zone.size_mb | default(0) }} MB</td>
                                <td class="py-3 px-3">
                                    {% if zone.is_parsed %}
                                        <span class="font-semibold text-neon-cyan font-mono">{{ zone.sld_count }}</span>
                                    {% elif zone.sld_count is string %}
                                        <span class="text-amber-400 text-xs">{{ zone.sld_count }}</span>
                                    {% else %}
                                        <span class="text-mist/40">-</span>
                                    {% endif %}
                                </td>
                                <td class="py-3 px-3">
                                    {% if zone.is_parsed %}
                                        <span class="px-2 py-1 text-xs rounded-lg bg-neon-green/10 text-neon-green font-medium">‚úì Parsed</span>
                                    {% elif zone.error %}
                                        <span class="px-2 py-1 text-xs rounded-lg bg-red-500/10 text-red-400 font-medium">‚úó Error</span>
                                    {% else %}
                                        <span class="px-2 py-1 text-xs rounded-lg bg-amber-500/10 text-amber-400 font-medium">‚ö† Not Parsed</span>
                                    {% endif %}
                                </td>
                                <td class="py-3 px-3">
                                    {% if not zone.is_parsed and not zone.error %}
                                        {% if zone.date %}
                                            <button onclick="parseZone('{{ tld.name }}', '{{ zone.name }}', '{{ zone.date }}')" 
                                                class="px-3 py-1.5 bg-neon-green/10 hover:bg-neon-green/20 text-neon-green text-xs font-semibold rounded-lg transition-colors">
                                                üì• Parse
                                            </button>
                                        {% else %}
                                            <span class="text-xs text-red-400">‚ö†Ô∏è Date missing</span>
                                        {% endif %}
                                    {% elif zone.is_parsed %}
                                        <span class="text-xs text-neon-green">‚úì Done</span>
                                    {% elif zone.error %}
                                        <span class="text-xs text-red-400">‚úó Error</span>
                                    {% else %}
                                        <span class="text-xs text-mist/40">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-8 text-mist/60">
                    No zone files found for this TLD.
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-12 text-mist/60">
                No TLDs found in database.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Recent Drops -->
    <div class="relative rounded-2xl bg-gradient-to-br from-night to-carbon border border-steel/50 p-8 mb-6 overflow-hidden">
        <div class="absolute top-0 right-0 w-40 h-40 bg-neon-green/5 rounded-full blur-3xl"></div>
        <div class="relative">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-xl bg-neon-green/10 flex items-center justify-center">
                    <span class="text-2xl">üÜï</span>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-frost">Recent Drops (Last 50)</h2>
                    <p class="text-sm text-mist">Samples from all parsed TLDs</p>
                </div>
            </div>
            
            {% if status.recent_drops %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-steel/30">
                            <th class="text-left py-3 px-4 text-mist font-medium text-sm uppercase tracking-wider">Domain</th>
                            <th class="text-left py-3 px-4 text-mist font-medium text-sm uppercase tracking-wider">TLD</th>
                            <th class="text-left py-3 px-4 text-mist font-medium text-sm uppercase tracking-wider">Drop Date</th>
                            <th class="text-left py-3 px-4 text-mist font-medium text-sm uppercase tracking-wider">Length</th>
                            <th class="text-left py-3 px-4 text-mist font-medium text-sm uppercase tracking-wider">Type</th>
                            <th class="text-left py-3 px-4 text-mist font-medium text-sm uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-steel/20">
                        {% for drop in status.recent_drops %}
                        <tr class="hover:bg-steel/20 transition-colors group cursor-pointer" onclick="copyDomain('{{ drop.domain }}.{{ drop.tld }}')">
                            <td class="py-3 px-4 font-mono text-sm text-frost group-hover:text-neon-cyan transition-colors">{{ drop.domain }}</td>
                            <td class="py-3 px-4">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-lg bg-neon-purple/10 text-neon-purple text-sm font-medium">.{{ drop.tld }}</span>
                            </td>
                            <td class="py-3 px-4 font-mono text-mist text-sm">{{ drop.drop_date }}</td>
                            <td class="py-3 px-4">
                                <span class="inline-flex items-center justify-center w-7 h-7 rounded-lg bg-steel/50 text-frost font-mono text-xs">{{ drop.length }}</span>
                            </td>
                            <td class="py-3 px-4">
                                {% if drop.charset_type == 'letters' %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-lg bg-blue-500/10 text-blue-400 text-xs font-medium">ABC</span>
                                {% elif drop.charset_type == 'numbers' %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-lg bg-emerald-500/10 text-emerald-400 text-xs font-medium">123</span>
                                {% else %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-lg bg-amber-500/10 text-amber-400 text-xs font-medium">MIX</span>
                                {% endif %}
                            </td>
                            <td class="py-3 px-4">
                                <button onclick="event.stopPropagation(); copyDomain('{{ drop.domain }}.{{ drop.tld }}')" class="px-3 py-1 bg-steel/50 hover:bg-neon-cyan/20 text-mist hover:text-neon-cyan rounded-lg text-xs font-medium transition-all">
                                    Copy
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12 text-mist/60">
                No drops found in database.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Import Logs -->
    <div id="import-logs-section" class="relative rounded-2xl bg-gradient-to-br from-night to-carbon border border-steel/50 p-8 mb-6 overflow-hidden">
        <div class="absolute top-0 right-0 w-40 h-40 bg-amber-500/5 rounded-full blur-3xl"></div>
        <div class="relative">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-xl bg-amber-500/10 flex items-center justify-center">
                        <span class="text-2xl">üìã</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-frost">Import Logs</h2>
                        <p class="text-sm text-mist">Son i≈ülem loglarƒ± ve hata takibi</p>
                    </div>
                </div>
                <button id="refresh-logs" class="px-4 py-2 bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 rounded-xl text-sm font-medium transition-colors">
                    üîÑ Loglarƒ± Yenile
                </button>
            </div>
            
            <div id="import-logs-content" class="space-y-3">
                <div class="text-center py-8 text-mist/60">
                    <div class="animate-pulse">Loglar y√ºkleniyor...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Summary -->
    <div class="relative rounded-2xl bg-blue-500/5 border border-blue-500/20 p-6">
        <h3 class="font-semibold text-blue-400 mb-3 flex items-center gap-2">
            <span>üìù</span> How to Check
        </h3>
        <ul class="list-disc list-inside text-sm text-blue-300/80 space-y-2">
            <li><strong class="text-blue-300">Download:</strong> Check if zone files exist in "TLDs & Zone Files" section</li>
            <li><strong class="text-blue-300">Parse:</strong> Check "SLDs Found" column - should show number of domains</li>
            <li><strong class="text-blue-300">DB Insert:</strong> Check "Recent Drops" section - domains should appear here</li>
            <li><strong class="text-blue-300">Auto Process:</strong> When downloading via admin panel with <code class="px-1.5 py-0.5 bg-blue-500/20 rounded text-blue-300">auto_process=true</code>, files are automatically parsed</li>
            <li><strong class="text-blue-300">Drop Detection:</strong> Drops tespit etmek i√ßin <strong class="text-amber-400">en az 2 ardƒ±≈üƒ±k g√ºn</strong> veri gerekir - √∂nceki g√ºn yoksa 0 drop g√∂sterilir</li>
        </ul>
    </div>
</div>

<script>
// Auto-refresh functionality
let autoRefreshInterval = null;
let isRefreshing = false;

document.addEventListener('DOMContentLoaded', function() {
    updateLastUpdateTime();
    
    const toggle = document.getElementById('auto-refresh-toggle');
    const intervalSelect = document.getElementById('refresh-interval');
    const manualRefresh = document.getElementById('manual-refresh');
    const statusIndicator = document.getElementById('auto-refresh-status');
    
    // Load saved preferences
    const savedAutoRefresh = localStorage.getItem('debug_auto_refresh') === 'true';
    const savedInterval = localStorage.getItem('debug_refresh_interval') || '10000';
    
    toggle.checked = savedAutoRefresh;
    intervalSelect.value = savedInterval;
    
    if (savedAutoRefresh) {
        startAutoRefresh(parseInt(savedInterval));
        statusIndicator.classList.remove('hidden');
    }
    
    // Toggle auto-refresh
    toggle.addEventListener('change', function() {
        localStorage.setItem('debug_auto_refresh', this.checked);
        
        if (this.checked) {
            startAutoRefresh(parseInt(intervalSelect.value));
            statusIndicator.classList.remove('hidden');
        } else {
            stopAutoRefresh();
            statusIndicator.classList.add('hidden');
        }
    });
    
    // Change interval
    intervalSelect.addEventListener('change', function() {
        localStorage.setItem('debug_refresh_interval', this.value);
        
        if (toggle.checked) {
            stopAutoRefresh();
            startAutoRefresh(parseInt(this.value));
        }
    });
    
    // Manual refresh
    manualRefresh.addEventListener('click', function() {
        refreshPage();
    });
});

function startAutoRefresh(interval) {
    stopAutoRefresh();
    autoRefreshInterval = setInterval(() => {
        refreshPage();
    }, interval);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

async function refreshPage() {
    if (isRefreshing) return;
    isRefreshing = true;
    
    const indicator = document.getElementById('refresh-indicator');
    indicator.classList.remove('hidden');
    
    try {
        // Fetch the page content
        const response = await fetch(window.location.href);
        const html = await response.text();
        
        // Parse the response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Update specific sections
        const sections = [
            'parseStatus',
            // Update the main content sections by their container
        ];
        
        // For now, just reload the entire page for simplicity
        // In a more advanced implementation, we could update only specific sections
        window.location.reload();
        
    } catch (error) {
        console.error('Refresh error:', error);
    } finally {
        isRefreshing = false;
        indicator.classList.add('hidden');
    }
}

function updateLastUpdateTime() {
    const el = document.getElementById('last-update');
    if (el) {
        el.textContent = new Date().toLocaleTimeString();
    }
}

async function parseZone(tld, zoneFile, zoneDate) {
    if (!tld || !zoneFile || !zoneDate || zoneDate === 'None' || zoneDate === 'N/A') {
        alert('Hata: Zone dosyasƒ± tarihi eksik veya ge√ßersiz!');
        return;
    }
    
    const statusDiv = document.getElementById('parseStatus');
    const button = event.target;
    const originalText = button.textContent;
    
    button.disabled = true;
    button.textContent = '‚è≥ Parsing...';
    button.className = 'px-3 py-1.5 bg-amber-500/20 text-amber-400 text-xs font-semibold rounded-lg cursor-not-allowed';
    
    statusDiv.className = 'bg-blue-500/10 border border-blue-500/30 rounded-2xl p-6 mb-6';
    statusDiv.innerHTML = `<div class="flex items-center"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-400 mr-3"></div><span class="text-blue-300">Starting parse for <strong class="text-blue-400">${tld}/${zoneFile}</strong>...</span></div>`;
    statusDiv.classList.remove('hidden');
    
    let jobId = null;
    let progressInterval = null;
    
    // Helper function to safely parse JSON
    async function safeJsonParse(response) {
        const text = await response.text();
        if (!text || text.trim() === '') {
            throw new Error('Empty response from server');
        }
        try {
            return JSON.parse(text);
        } catch (e) {
            console.error('JSON parse error:', e);
            console.error('Response text:', text.substring(0, 200));
            throw new Error(`Invalid JSON response: ${e.message}. Response: ${text.substring(0, 100)}...`);
        }
    }
    
    // Progress polling function
    async function pollProgress(jobId) {
        try {
            const response = await fetch(`/api/v1/import/progress/${jobId}`);
            if (!response.ok) {
                return null;
            }
            const progress = await safeJsonParse(response);
            return progress;
        } catch (error) {
            console.error('Progress poll error:', error);
            return null;
        }
    }
    
    // Update UI with progress
    function updateProgressUI(progress) {
        if (!progress || !progress.success) return;
        
        const status = progress.status;
        const current = progress.current || 0;
        const total = progress.total || 0;
        const progressPct = progress.progress || 0;
        const message = progress.message || 'Processing...';
        
        let statusClass = 'bg-blue-500/10 border border-blue-500/30';
        let statusIcon = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-400 mr-3"></div>';
        
        if (status === 'completed') {
            statusClass = 'bg-neon-green/10 border border-neon-green/30';
            statusIcon = '<div class="text-neon-green text-xl mr-3">‚úÖ</div>';
        } else if (status === 'failed') {
            statusClass = 'bg-red-500/10 border border-red-500/30';
            statusIcon = '<div class="text-red-400 text-xl mr-3">‚ùå</div>';
        }
        
        let html = `<div class="flex items-center">${statusIcon}`;
        html += `<div class="flex-1">`;
        html += `<div class="text-blue-300 mb-2"><strong>${message}</strong></div>`;
        
        if (total > 0) {
            html += `<div class="w-full bg-gray-700 rounded-full h-2.5 mb-2">`;
            html += `<div class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: ${progressPct}%"></div>`;
            html += `</div>`;
            html += `<div class="text-sm text-mist">Progress: ${current.toLocaleString()} / ${total.toLocaleString()} (${progressPct}%)</div>`;
        } else {
            html += `<div class="text-sm text-mist">${message}</div>`;
        }
        
        if (progress.details) {
            const details = progress.details;
            if (details.imported !== undefined || details.skipped !== undefined) {
                html += `<div class="mt-2 text-xs text-mist">`;
                if (details.imported !== undefined) html += `Imported: <strong class="text-neon-green">${details.imported.toLocaleString()}</strong> `;
                if (details.skipped !== undefined) html += `Skipped: <strong class="text-mist">${details.skipped.toLocaleString()}</strong> `;
                if (details.errors !== undefined && details.errors > 0) html += `Errors: <strong class="text-red-400">${details.errors.toLocaleString()}</strong>`;
                html += `</div>`;
            }
        }
        
        html += `</div></div>`;
        
        statusDiv.className = statusClass + ' rounded-2xl p-6 mb-6';
        statusDiv.innerHTML = html;
        
        // Stop polling if completed or failed
        if (status === 'completed' || status === 'failed') {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            
            if (status === 'completed') {
                button.textContent = '‚úì Parsed';
                button.className = 'px-3 py-1.5 bg-neon-green/20 text-neon-green text-xs font-semibold rounded-lg cursor-default';
                button.disabled = true;
                
                // Notify other tabs/windows
                localStorage.setItem('debug_last_update', Date.now().toString());
                
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                button.disabled = false;
                button.textContent = originalText;
                button.className = 'px-3 py-1.5 bg-neon-green/10 hover:bg-neon-green/20 text-neon-green text-xs font-semibold rounded-lg transition-colors';
            }
        }
    }
    
    try {
        const url = `/api/v1/import/single-zone?tld=${encodeURIComponent(tld)}&zone_date=${encodeURIComponent(zoneDate)}&use_chunks=true`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            const errorData = await safeJsonParse(response);
            throw new Error(errorData.detail || `HTTP ${response.status}: Parse failed`);
        }
        
        const data = await safeJsonParse(response);
        
        if (data.success && data.job_id) {
            jobId = data.job_id;
            
            // Start polling for progress
            progressInterval = setInterval(async () => {
                const progress = await pollProgress(jobId);
                if (progress) {
                    updateProgressUI(progress);
                }
            }, 2000); // Poll every 2 seconds
            
            // Initial progress update
            const initialProgress = await pollProgress(jobId);
            if (initialProgress) {
                updateProgressUI(initialProgress);
            }
        } else if (data.success) {
            // Fallback for non-chunked responses
            statusDiv.className = 'bg-neon-green/10 border border-neon-green/30 rounded-2xl p-6 mb-6';
            let html = `<div class="text-neon-green"><strong>‚úÖ Parse & Import Complete!</strong></div>`;
            html += `<div class="mt-3 space-y-1 text-sm text-mist">`;
            html += `<p>Zone file: <strong class="text-frost">${tld}/${zoneFile}</strong></p>`;
            if (data.sld_count !== undefined) html += `<p>SLDs found: <strong class="text-neon-cyan">${data.sld_count.toLocaleString()}</strong></p>`;
            if (data.imported !== undefined) html += `<p>Imported to DB: <strong class="text-neon-green">${data.imported.toLocaleString()}</strong> domains</p>`;
            if (data.skipped !== undefined) html += `<p>Skipped: <strong class="text-mist">${data.skipped.toLocaleString()}</strong></p>`;
            html += `</div>`;
            statusDiv.innerHTML = html;
            
            button.textContent = '‚úì Parsed';
            button.className = 'px-3 py-1.5 bg-neon-green/20 text-neon-green text-xs font-semibold rounded-lg cursor-default';
            button.disabled = true;
            
            localStorage.setItem('debug_last_update', Date.now().toString());
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            throw new Error('Parse failed');
        }
    } catch (error) {
        if (progressInterval) {
            clearInterval(progressInterval);
        }
        
        statusDiv.className = 'bg-red-500/10 border border-red-500/30 rounded-2xl p-6 mb-6';
        statusDiv.innerHTML = `<div class="text-red-400"><strong>‚ùå Error parsing ${tld}/${zoneFile}:</strong> ${error.message}</div>`;
        
        button.disabled = false;
        button.textContent = originalText;
        button.className = 'px-3 py-1.5 bg-neon-green/10 hover:bg-neon-green/20 text-neon-green text-xs font-semibold rounded-lg transition-colors';
    }
}

// Listen for updates from other tabs
window.addEventListener('storage', function(e) {
    if (e.key === 'debug_last_update') {
        // Another tab made an update, refresh this page
        setTimeout(() => window.location.reload(), 1000);
    }
});

// Copy domain to clipboard
function copyDomain(domain) {
    navigator.clipboard.writeText(domain).then(() => {
        const toast = document.getElementById('toast');
        const message = document.getElementById('toast-message');
        if (toast && message) {
            message.textContent = `Copied: ${domain}`;
            toast.classList.remove('hidden', 'translate-y-4', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-4', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 2000);
        }
    });
}

// Load import logs
async function loadImportLogs() {
    const container = document.getElementById('import-logs-content');
    try {
        const response = await fetch('/api/v1/import/logs?limit=10');
        const data = await response.json();
        
        if (data.logs && data.logs.length > 0) {
            let html = '<div class="space-y-3">';
            for (const log of data.logs) {
                const statusColor = log.success ? 'neon-green' : 'red-400';
                const statusIcon = log.success ? '‚úÖ' : '‚ùå';
                const duration = log.duration_seconds ? log.duration_seconds.toFixed(1) + 's' : 'N/A';
                
                html += `
                    <div class="p-4 rounded-xl bg-void/50 border border-steel/30">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <span class="text-lg">${statusIcon}</span>
                                <span class="inline-flex items-center px-2 py-0.5 rounded-lg bg-neon-purple/10 text-neon-purple text-sm font-medium">.${log.tld}</span>
                                <span class="text-mist text-sm">${log.operation}</span>
                            </div>
                            <div class="text-xs text-mist">
                                ${new Date(log.start_time).toLocaleString()}
                            </div>
                        </div>
                        <div class="flex gap-4 text-xs text-mist">
                            <span>S√ºre: <strong class="text-frost">${duration}</strong></span>
                            ${log.stats?.imported !== undefined ? `<span>ƒ∞√ße aktarƒ±lan: <strong class="text-neon-green">${log.stats.imported.toLocaleString()}</strong></span>` : ''}
                            ${log.stats?.skipped !== undefined ? `<span>Atlanan: <strong class="text-mist">${log.stats.skipped.toLocaleString()}</strong></span>` : ''}
                            ${log.stats?.errors !== undefined && log.stats.errors > 0 ? `<span>Hata: <strong class="text-red-400">${log.stats.errors}</strong></span>` : ''}
                        </div>
                        ${log.errors && log.errors.length > 0 ? `
                            <div class="mt-2 p-2 rounded-lg bg-red-500/10 text-red-400 text-xs">
                                <strong>Hatalar:</strong>
                                <ul class="list-disc list-inside mt-1">
                                    ${log.errors.map(e => `<li>${e.message}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<div class="text-center py-8 text-mist/60">Hen√ºz import logu yok.</div>';
        }
    } catch (error) {
        container.innerHTML = `<div class="text-center py-8 text-red-400">Log y√ºklenemedi: ${error.message}</div>`;
    }
}

// Load logs on page load
document.addEventListener('DOMContentLoaded', function() {
    loadImportLogs();
    
    document.getElementById('refresh-logs')?.addEventListener('click', function() {
        loadImportLogs();
    });
});
</script>
{% endblock %}
